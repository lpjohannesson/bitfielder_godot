[gd_scene load_steps=57 format=3 uid="uid://dofu8ik7dtua1"]

[ext_resource type="Script" path="res://assets/scenes/game_scene.gd" id="1_jdhth"]
[ext_resource type="Shader" path="res://assets/shaders/shadow.gdshader" id="2_d1sjh"]
[ext_resource type="Script" path="res://assets/objects/block/block_type.gd" id="3_g8yh0"]
[ext_resource type="Script" path="res://assets/objects/block/render/basic_block_renderer.gd" id="4_v3r6d"]
[ext_resource type="Script" path="res://assets/objects/block/render/auto_block_renderer.gd" id="5_gkvnp"]
[ext_resource type="Texture2D" uid="uid://coiww15bo3bl2" path="res://assets/textures/blocks/particles/dirt.png" id="5_gqgo5"]
[ext_resource type="Texture2D" uid="uid://duli3c05kcek2" path="res://assets/textures/blocks/dirt.png" id="6_nqvwl"]
[ext_resource type="Texture2D" uid="uid://c26yxs3na7guy" path="res://assets/textures/blocks/stone.png" id="6_vg04p"]
[ext_resource type="PackedScene" uid="uid://omkj7o5gbs7m" path="res://assets/objects/block/block_chunk.tscn" id="7_ngtea"]
[ext_resource type="Texture2D" uid="uid://eer33eptpvf7" path="res://assets/textures/blocks/particles/stone.png" id="7_qopnm"]
[ext_resource type="Script" path="res://assets/objects/block/block_generator.gd" id="8_isevc"]
[ext_resource type="Texture2D" uid="uid://c7ai3koyxbi1o" path="res://assets/textures/blocks/grass.png" id="8_ql2sl"]
[ext_resource type="PackedScene" uid="uid://qhbwwmg422j6" path="res://assets/objects/player.tscn" id="9_x3p4l"]
[ext_resource type="PackedScene" uid="uid://qnuf5qyuxwxp" path="res://assets/objects/block/render/block_particle.tscn" id="10_23lyr"]
[ext_resource type="Texture2D" uid="uid://dtr4vbkje7np6" path="res://assets/textures/blocks/particles/wood.png" id="11_do6fe"]
[ext_resource type="Texture2D" uid="uid://bix3avmlaqday" path="res://assets/textures/blocks/wood_log.png" id="12_1m4gx"]
[ext_resource type="Texture2D" uid="uid://c1b17f11sambd" path="res://assets/textures/blocks/wood_planks.png" id="13_bl4s3"]
[ext_resource type="Texture2D" uid="uid://3y74r12ljned" path="res://assets/textures/blocks/particles/leaves.png" id="14_17ee4"]
[ext_resource type="Texture2D" uid="uid://elh7ruh3dmor" path="res://assets/textures/blocks/leaves.png" id="15_o2avx"]
[ext_resource type="Texture2D" uid="uid://c7j0mohutqrgm" path="res://assets/textures/blocks/particles/wool.png" id="16_jfrdu"]
[ext_resource type="Texture2D" uid="uid://dck6lqh1cp6ya" path="res://assets/textures/blocks/bush.png" id="17_u3i6e"]
[ext_resource type="Texture2D" uid="uid://bwfic1idywgn5" path="res://assets/textures/blocks/water1.png" id="18_iqmbb"]
[ext_resource type="Texture2D" uid="uid://c4lrbc48ntiho" path="res://assets/textures/blocks/mushroom.png" id="19_kt82i"]
[ext_resource type="Texture2D" uid="uid://biijynwundait" path="res://assets/textures/blocks/water2.png" id="19_u67dn"]
[ext_resource type="Texture2D" uid="uid://cxrmxtylltkfg" path="res://assets/textures/blocks/water3.png" id="20_5gmkf"]
[ext_resource type="Texture2D" uid="uid://ce5j2r2ocoib2" path="res://assets/textures/blocks/torch.png" id="20_iitlb"]
[ext_resource type="Texture2D" uid="uid://c6bt1ruq7ry6v" path="res://assets/textures/blocks/water4.png" id="21_t0loi"]
[ext_resource type="Texture2D" uid="uid://ccqxd3u7mbj30" path="res://assets/textures/blocks/wheat.png" id="25_pqeg7"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_hm8g0"]
shader = ExtResource("2_d1sjh")
shader_parameter/back_shade = 0.2
shader_parameter/shadow_shade = 0.3

[sub_resource type="GDScript" id="GDScript_jls0v"]
script/source = "extends Node2D
class_name BlockWorld

@export var block_types: Array[BlockType]
@export var chunk_scene: PackedScene
@export var particle_scene: PackedScene

@export var chunks: Node2D
@export var particles: Node2D
@export var generator: BlockGenerator

var chunk_map := {}

static func get_chunk_index(block_position: Vector2i) -> Vector2i:
	return floor(Vector2(block_position) / Vector2(BlockChunk.CHUNK_SIZE))

static func get_chunk_position(
	block_position: Vector2i,
	chunk_index: Vector2i) -> Vector2i:
	
	return block_position - chunk_index * BlockChunk.CHUNK_SIZE

static func get_block_position(
	chunk_position: Vector2i,
	chunk_index: Vector2i) -> Vector2i:
	
	return chunk_position + chunk_index * BlockChunk.CHUNK_SIZE

func world_to_block(world_position: Vector2) -> Vector2i:
	return floor(world_position / scale)

func block_to_world(block_position: Vector2i, centered: bool) -> Vector2:
	var world_position := Vector2(block_position) * scale
	
	if centered:
		return world_position + scale * 0.5
	else:
		return world_position

func get_chunk(chunk_index: Vector2i) -> BlockChunk:
	if not chunk_map.has(chunk_index):
		return null
	
	return chunk_map[chunk_index]

func get_block_address(block_position: Vector2i) -> BlockAddress:
	# Find chunk by index
	var chunk_index := get_chunk_index(block_position)
	var chunk := get_chunk(chunk_index)
	
	if chunk == null:
		return null
	
	# Create address
	var address = BlockAddress.new()
	address.chunk = chunk
	
	# Get block position relative to chunk
	var chunk_position = get_chunk_position(block_position, chunk_index)
	
	address.block_index = \\
		BlockChunk.get_block_index(chunk_position)
	
	return address

func create_colliders(chunk: BlockChunk) -> void:
	for y in range(BlockChunk.CHUNK_SIZE.y):
		for x in range(BlockChunk.CHUNK_SIZE.x):
			var chunk_position := Vector2i(x, y)
			var block_index := BlockChunk.get_block_index(chunk_position)
			var block_id := chunk.front_ids[block_index]
			var block := block_types[block_id]
			
			if not block.is_solid:
				continue
			
			var collider := CollisionShape2D.new()
			chunk.colliders.add_child(collider)
			
			collider.position = Vector2(chunk_position) + Vector2.ONE * 0.5
			collider.shape = RectangleShape2D.new()
			collider.shape.size = Vector2.ONE

func draw_block(block_id: int, render_data: BlockRenderData) -> void:
	var block := block_types[block_id]
	
	if block.renderer == null:
		return
	
	block.renderer.draw_block(render_data)

func draw_chunk(
	chunk: BlockChunk,
	block_ids: PackedInt32Array,
	layer: Node2D,
	on_front_layer: bool) -> void:
	
	var render_data := BlockRenderData.new()
	render_data.chunk = chunk
	render_data.layer = layer
	render_data.on_front_layer = on_front_layer
	
	for y in range(BlockChunk.CHUNK_SIZE.y):
		for x in range(BlockChunk.CHUNK_SIZE.x):
			render_data.chunk_position = Vector2i(x, y)
			var block_index := \\
				BlockChunk.get_block_index(render_data.chunk_position)
			
			draw_block(block_ids[block_index], render_data)

func draw_chunk_front(chunk: BlockChunk) -> void:
	draw_chunk(chunk, chunk.front_ids, chunk.front_layer, true)

func draw_chunk_back(chunk: BlockChunk) -> void:
	draw_chunk(chunk, chunk.back_ids, chunk.back_layer, false)

func draw_chunk_shadow(chunk: BlockChunk) -> void:
	var render_data := BlockRenderData.new()
	render_data.chunk = chunk
	render_data.layer = chunk.shadow_layer
	render_data.on_front_layer = true
	
	for y in range(BlockChunk.CHUNK_SIZE.y):
		for x in range(BlockChunk.CHUNK_SIZE.x):
			render_data.chunk_position = Vector2i(x, y)
			var block_index := \\
				BlockChunk.get_block_index(render_data.chunk_position)
			
			var block_id := chunk.front_ids[block_index]
			var block := block_types[block_id]
			
			if block.renderer == null:
				continue
			
			var block_rect := Rect2(render_data.chunk_position, Vector2.ONE)
			render_data.layer.draw_rect(block_rect, Color.WHITE)

func create_chunk(chunk_index: Vector2i) -> void:
	var chunk: BlockChunk = chunk_scene.instantiate()
	
	chunk.chunk_index = chunk_index
	chunk.position = chunk_index * BlockChunk.CHUNK_SIZE
	chunks.add_child(chunk)
	
	chunk_map[chunk_index] = chunk
	
	generator.generate_chunk(chunk)
	create_colliders(chunk)
	
	chunk.front_layer.draw.connect(func() -> void: draw_chunk_front(chunk))
	chunk.back_layer.draw.connect(func() -> void: draw_chunk_back(chunk))
	chunk.shadow_layer.draw.connect(func() -> void: draw_chunk_shadow(chunk))

func update_chunk(chunk: BlockChunk) -> void:
	chunk.redraw_chunk()
	
	for collider in chunk.colliders.get_children():
		collider.free()
	
	create_colliders(chunk)

func update_block(block_position: Vector2i):
	# Find chunks including neighbours
	var chunk_start := get_chunk_index(block_position - Vector2i.ONE)
	var chunk_end := get_chunk_index(block_position + Vector2i.ONE)
	var chunk_count := Vector2i.ONE + (chunk_end - chunk_start)
	
	for y in range(chunk_count.y):
		for x in range(chunk_count.x):
			var chunk_index = chunk_start + Vector2i(x, y)
			var chunk := get_chunk(chunk_index)
			
			if chunk == null:
				continue
			
			update_chunk(chunk)

func create_particles(block_id: int, block_position: Vector2i):
	var block := block_types[block_id]
	
	if block.renderer == null:
		return
	
	var particle_texture := block.renderer.particle_texture
	
	if particle_texture == null:
		return
	
	var particle_position = block_to_world(block_position, true)
	
	for i in range(5):
		var particle: BlockParticle = particle_scene.instantiate()
		particles.add_child(particle)
		
		particle.global_position = particle_position
		particle.sprite.texture = particle_texture

func _ready() -> void:
	for y in range(4):
		for x in range(4):
			create_chunk(Vector2i(x, y))
"

[sub_resource type="Resource" id="Resource_kkgt4"]
script = ExtResource("3_g8yh0")
block_name = "air"
is_solid = false

[sub_resource type="Resource" id="Resource_0f5wa"]
script = ExtResource("5_gkvnp")
texture = ExtResource("6_nqvwl")
particle_texture = ExtResource("5_gqgo5")
is_partial = null

[sub_resource type="Resource" id="Resource_qm0y7"]
script = ExtResource("3_g8yh0")
block_name = "dirt"
renderer = SubResource("Resource_0f5wa")
is_solid = true

[sub_resource type="Resource" id="Resource_cgdcr"]
script = ExtResource("5_gkvnp")
texture = ExtResource("8_ql2sl")
particle_texture = ExtResource("5_gqgo5")
is_partial = null

[sub_resource type="Resource" id="Resource_4kr1q"]
script = ExtResource("3_g8yh0")
block_name = "grass"
renderer = SubResource("Resource_cgdcr")
is_solid = true

[sub_resource type="Resource" id="Resource_7eae8"]
script = ExtResource("5_gkvnp")
texture = ExtResource("6_vg04p")
particle_texture = ExtResource("7_qopnm")
is_partial = null

[sub_resource type="Resource" id="Resource_6xmik"]
script = ExtResource("3_g8yh0")
block_name = "stone"
renderer = SubResource("Resource_7eae8")
is_solid = true

[sub_resource type="Resource" id="Resource_cxod0"]
script = ExtResource("5_gkvnp")
texture = ExtResource("12_1m4gx")
particle_texture = ExtResource("11_do6fe")
is_partial = null

[sub_resource type="Resource" id="Resource_noqob"]
script = ExtResource("3_g8yh0")
block_name = "wood_log"
renderer = SubResource("Resource_cxod0")
is_solid = true

[sub_resource type="Resource" id="Resource_ufgfi"]
script = ExtResource("5_gkvnp")
texture = ExtResource("13_bl4s3")
particle_texture = ExtResource("11_do6fe")
is_partial = null

[sub_resource type="Resource" id="Resource_bmvjm"]
script = ExtResource("3_g8yh0")
block_name = "wood_planks"
renderer = SubResource("Resource_ufgfi")
is_solid = true

[sub_resource type="Resource" id="Resource_5gejc"]
script = ExtResource("5_gkvnp")
texture = ExtResource("15_o2avx")
particle_texture = ExtResource("14_17ee4")
is_partial = true

[sub_resource type="Resource" id="Resource_o7m25"]
script = ExtResource("3_g8yh0")
block_name = "leaves"
renderer = SubResource("Resource_5gejc")
is_solid = true

[sub_resource type="Resource" id="Resource_oriv6"]
script = ExtResource("4_v3r6d")
texture = ExtResource("17_u3i6e")
particle_texture = ExtResource("14_17ee4")
is_partial = true

[sub_resource type="Resource" id="Resource_125rs"]
script = ExtResource("3_g8yh0")
block_name = "bush"
renderer = SubResource("Resource_oriv6")
is_solid = false

[sub_resource type="Resource" id="Resource_ba0f8"]
script = ExtResource("4_v3r6d")
texture = ExtResource("25_pqeg7")
particle_texture = ExtResource("14_17ee4")
is_partial = true

[sub_resource type="Resource" id="Resource_5t3x1"]
script = ExtResource("3_g8yh0")
block_name = "wheat"
renderer = SubResource("Resource_ba0f8")
is_solid = false

[sub_resource type="Resource" id="Resource_adrdq"]
script = ExtResource("4_v3r6d")
texture = ExtResource("19_kt82i")
particle_texture = ExtResource("16_jfrdu")
is_partial = true

[sub_resource type="Resource" id="Resource_1o8vl"]
script = ExtResource("3_g8yh0")
block_name = "mushroom"
renderer = SubResource("Resource_adrdq")
is_solid = false

[sub_resource type="Resource" id="Resource_bbnab"]
script = ExtResource("4_v3r6d")
texture = ExtResource("20_iitlb")
particle_texture = ExtResource("11_do6fe")
is_partial = true

[sub_resource type="Resource" id="Resource_iyiq0"]
script = ExtResource("3_g8yh0")
block_name = "torch"
renderer = SubResource("Resource_bbnab")
is_solid = false

[sub_resource type="AnimatedTexture" id="AnimatedTexture_qsd5h"]
frames = 4
speed_scale = 5.0
frame_0/texture = ExtResource("18_iqmbb")
frame_1/texture = ExtResource("19_u67dn")
frame_1/duration = 1.0
frame_2/texture = ExtResource("20_5gmkf")
frame_2/duration = 1.0
frame_3/texture = ExtResource("21_t0loi")
frame_3/duration = 1.0

[sub_resource type="Resource" id="Resource_jclyr"]
script = ExtResource("4_v3r6d")
texture = SubResource("AnimatedTexture_qsd5h")
particle_texture = ExtResource("16_jfrdu")
is_partial = true

[sub_resource type="Resource" id="Resource_l6x1t"]
script = ExtResource("3_g8yh0")
block_name = "water"
renderer = SubResource("Resource_jclyr")
is_solid = false

[sub_resource type="Gradient" id="Gradient_7u5hj"]
offsets = PackedFloat32Array(0.2, 0.4, 0.6, 0.8)
colors = PackedColorArray(0.13583, 0.0257736, 0.20906, 1, 0.18053, 0.321128, 0.573004, 1, 0, 0.705882, 0.811765, 1, 0.6, 1, 0.966667, 1)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_uk2xc"]
gradient = SubResource("Gradient_7u5hj")
width = 1
fill_from = Vector2(0, 1)
fill_to = Vector2(0, 0)

[node name="GameScene" type="Node2D" node_paths=PackedStringArray("block_world", "shadow_viewport")]
script = ExtResource("1_jdhth")
block_world = NodePath("BlockWorld")
shadow_viewport = NodePath("ShadowViewport")
shadow_shader = SubResource("ShaderMaterial_hm8g0")

[node name="BlockWorld" type="Node2D" parent="." node_paths=PackedStringArray("chunks", "particles", "generator")]
scale = Vector2(16, 16)
script = SubResource("GDScript_jls0v")
block_types = Array[ExtResource("3_g8yh0")]([SubResource("Resource_kkgt4"), SubResource("Resource_qm0y7"), SubResource("Resource_4kr1q"), SubResource("Resource_6xmik"), SubResource("Resource_noqob"), SubResource("Resource_bmvjm"), SubResource("Resource_o7m25"), SubResource("Resource_125rs"), SubResource("Resource_5t3x1"), SubResource("Resource_1o8vl"), SubResource("Resource_iyiq0"), SubResource("Resource_l6x1t")])
chunk_scene = ExtResource("7_ngtea")
particle_scene = ExtResource("10_23lyr")
chunks = NodePath("Chunks")
particles = NodePath("Particles")
generator = NodePath("Generator")

[node name="Chunks" type="Node2D" parent="BlockWorld"]

[node name="Particles" type="Node2D" parent="BlockWorld"]
scale = Vector2(0.0625, 0.0625)

[node name="Generator" type="Node" parent="BlockWorld"]
script = ExtResource("8_isevc")

[node name="Player" parent="." instance=ExtResource("9_x3p4l")]
position = Vector2(10, -10)

[node name="ShadowViewport" type="SubViewport" parent="."]
transparent_bg = true
handle_input_locally = false
canvas_item_default_texture_filter = 0
size = Vector2i(40, 40)
render_target_update_mode = 4

[node name="ParallaxBackground" type="ParallaxBackground" parent="."]

[node name="ParallaxLayer" type="ParallaxLayer" parent="ParallaxBackground"]
motion_scale = Vector2(0, 0.5)

[node name="TextureRect" type="TextureRect" parent="ParallaxBackground/ParallaxLayer"]
offset_top = -128.0
offset_right = 512.0
offset_bottom = 896.0
texture = SubResource("GradientTexture2D_uk2xc")
expand_mode = 2
